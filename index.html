<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Video Player with Loop - Enhanced</title>
    <style>
        :root {
            --primary-bg: #121212;
            --secondary-bg: #1e1e1e;
            --tertiary-bg: #2d2d2d;
            --accent-color: #2c7be5;
            --text-color: #f0f0f0;
            --text-muted-color: #aaa;
            --slider-track-color: #333;
            --success-color: #4caf50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, 
                Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
            background-color: var(--secondary-bg);
        }
        
        .player-header {
            padding: 16px;
            background-color: var(--tertiary-bg);
            text-align: center;
        }
        
        .player-header h1 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            background-color: #000;
        }
        
        video {
            width: 100%;
            display: block;
        }
        
        /* Fullscreen styling - applied when native fullscreen is active on .video-container */
        .video-container.is-fullscreen {
            /* Browser handles fixed positioning, z-index etc. for native fullscreen */
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #000; /* Ensure background */
        }
        
        .video-container.is-fullscreen video {
            max-width: 100%;
            max-height: 100%;
            width: auto; /* Maintain aspect ratio */
            height: auto; /* Maintain aspect ratio */
            object-fit: contain;
        }
        
        .controls {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .main-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .file-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 16px; /* Added padding for consistency */
        }
        
        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: #1a68d1;
        }
        
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        .toggle-button {
            min-width: 100px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            background-color: var(--success-color);
            color: white;
            border-radius: 4px;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: center;
        }
        
        .file-label:hover {
            background-color: #3e8e41;
        }
        
        .file-name {
            padding: 5px;
            color: var(--text-muted-color);
            font-size: 14px;
            text-align: center;
            word-break: break-all;
        }
        
        .progress-container {
            width: 100%;
            height: 5px;
            background-color: var(--slider-track-color);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 8px;
            cursor: pointer;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--accent-color);
            width: 0;
            transition: width 0.1s;
        }
        
        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-muted-color);
            margin-top: 5px;
        }
        
        .volume-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }
        
        .volume-icon {
            color: var(--text-muted-color);
            width: 20px;
            text-align: center;
        }
        
        .volume-slider, .filter-slider, .sensor-adjust-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 5px;
            border-radius: 5px;
            background: var(--slider-track-color);
            outline: none;
        }
        
        .volume-slider::-webkit-slider-thumb,
        .filter-slider::-webkit-slider-thumb,
        .sensor-adjust-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
        }
        
        .volume-slider::-moz-range-thumb,
        .filter-slider::-moz-range-thumb,
        .sensor-adjust-slider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
        }
        
        .placeholder-message {
            padding: 30px;
            text-align: center;
            color: #888;
        }
        
        .loop-info {
            font-size: 12px;
            color: var(--text-muted-color);
            text-align: center;
            margin-top: 5px;
        }
        
        .filter-controls, .sensor-adjust-controls {
            padding: 12px 16px;
            background-color: #2a2a2a;
            border-top: 1px solid var(--slider-track-color);
            margin-top: 10px;
        }
         .filter-controls h3, .sensor-adjust-controls h3 {
            font-size: 15px;
            margin-bottom: 10px;
            color: var(--text-color);
         }
        
        .filter-control, .sensor-adjust-item {
            margin-bottom: 12px;
        }
        .filter-control:last-child, .sensor-adjust-item:last-child { margin-bottom: 0; }
        
        .control-label { /* Generic label for filter and sensor sliders/selects */
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
            color: #ddd;
        }
        
        .control-value { /* Generic value display for sliders */
            color: var(--accent-color);
            font-weight: 500;
        }
        
        .filter-reset, .sensor-adjust-reset {
            background-color: #555;
            margin-top: 10px;
            width: 100%;
            font-size: 13px;
            padding: 8px;
        }
        .filter-reset:hover, .sensor-adjust-reset:hover { background-color: #666; }

        .sensor-adjust-item label {
            font-size: 13px;
            color: #ccc;
            display: block;
            margin-bottom: 3px;
        }
        .sensor-adjust-item select {
            width: 100%;
            padding: 6px;
            background-color: var(--tertiary-bg);
            color: var(--text-color);
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 8px;
        }
        .sensor-adjust-slider { width: 100%; }
        
        /* Sensor section styling */
        .sensor-section {
            background-color: var(--secondary-bg); /* Match container background */
            border-radius: 0 0 8px 8px; /* Rounded bottom corners if it's the last element */
            padding: 15px;
            margin-top: 0; /* Removed margin-top as it's part of the container flow */
            border-top: 1px solid var(--slider-track-color);
        }
        
        .sensor-heading {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .sensor-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .sensor-toggle {
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .sensor-toggle.active {
            background-color: var(--success-color);
        }
        
        .sensor-values {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .sensor-value {
            background-color: var(--tertiary-bg);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }
        
        .value-label {
            font-size: 12px;
            color: var(--text-muted-color);
            margin-bottom: 5px;
        }
        
        .value-number {
            font-size: 16px;
            font-weight: 500;
            font-family: monospace;
            color: var(--accent-color);
        }
        
        .compass {
            width: 100px; /* Smaller compass */
            height: 100px;
            margin: 10px auto;
            position: relative;
            border-radius: 50%;
            background-color: var(--tertiary-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.5) inset;
        }
        
        .compass-needle {
            position: absolute;
            width: 3px;
            height: 70px; /* Adjusted for smaller compass */
            background: linear-gradient(to bottom, #f44336 50%, #fff 50%);
            transform-origin: center center;
            transition: transform 0.1s ease;
        }
        
        .compass-center {
            width: 10px; /* Adjusted */
            height: 10px;
            background-color: #333;
            border-radius: 50%;
            z-index: 1;
        }
        
        .compass-marker {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        
        .compass-marker span {
            position: absolute;
            width: 18px; /* Adjusted */
            font-size: 12px; /* Adjusted */
            text-align: center;
            font-weight: bold;
            color: #ddd;
        }
        
        .compass-marker .north { top: 5px; left: calc(50% - 9px); }
        .compass-marker .east { right: 5px; top: calc(50% - 9px); }
        .compass-marker .south { bottom: 5px; left: calc(50% - 9px); }
        .compass-marker .west { left: 5px; top: calc(50% - 9px); }
        
        .phone-visualization {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 15px 0;
        }
        
        .mapping-info {
            font-size: 13px;
            color: var(--text-muted-color);
            margin: 10px 0;
            text-align: center;
            line-height: 1.4;
        }
        
        .mapping-highlight {
            color: var(--accent-color);
            font-weight: 500;
        }
        
        @media (max-width: 480px) {
            .controls { padding: 12px; }
            button { padding: 8px 12px; font-size: 13px; }
            .toggle-button { min-width: 80px; }
            .file-label { padding: 8px 12px; font-size: 13px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="player-header">
            <h1>Enhanced Video Player</h1>
        </div>
        
        <div class="video-container" id="videoContainer">
            <video id="videoPlayer"></video>
        </div>
        
        <div id="placeholder" class="placeholder-message">
            <p>Select a video file to play</p>
        </div>
        
        <div class="controls" id="controls" style="display: none;">
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="time-display">
                <span id="currentTime">0:00</span>
                <span id="duration">0:00</span>
            </div>
            
            <div class="main-controls">
                <button id="playPauseBtn" class="toggle-button">Play</button>
                <button id="fullscreenBtn" class="toggle-button">Fullscreen</button>
                <button id="loopBtn" class="toggle-button">Loop: OFF</button>
            </div>
            
            <div class="volume-container">
                <div class="volume-icon">ðŸ”Š</div>
                <input type="range" min="0" max="1" step="0.05" value="1" class="volume-slider" id="volumeSlider">
            </div>
            
            <div class="loop-info" id="loopInfo"></div>
            
            <div class="filter-controls">
                <h3>Video Filters</h3>
                <div class="filter-control">
                    <div class="control-label">
                        <span>Brightness</span>
                        <span class="control-value" id="brightnessValue">100%</span>
                    </div>
                    <input type="range" min="25" max="200" value="100" class="filter-slider" id="brightnessSlider">
                </div>
                
                <div class="filter-control">
                    <div class="control-label">
                        <span>Saturation</span>
                        <span class="control-value" id="saturationValue">100%</span>
                    </div>
                    <input type="range" min="25" max="200" value="100" class="filter-slider" id="saturationSlider">
                </div>
                
                <div class="filter-control">
                    <div class="control-label">
                        <span>Contrast</span>
                        <span class="control-value" id="contrastValue">100%</span>
                    </div>
                    <input type="range" min="25" max="200" value="100" class="filter-slider" id="contrastSlider">
                </div>
                
                <button id="resetFiltersBtn" class="filter-reset">Reset All Filters</button>
            </div>
        </div>
        
        <div class="file-controls">
            <input type="file" id="fileInput" accept="video/*">
            <label for="fileInput" class="file-label">Choose Video File</label>
            <div class="file-name" id="fileName"></div>
        </div>
        
        <div class="sensor-section" id="sensorSection">
            <div class="sensor-heading">
                <div class="sensor-title">Motion Controls</div>
                <button id="sensorToggleBtn" class="sensor-toggle">Enable Sensors</button>
            </div>
            
            <div class="mapping-info" id="sensorMappingInfo">
                Tilt your device to control video effects (default mapping):
                <br>
                <span class="mapping-highlight">Rotation (Alpha)</span> â†’ Saturation â€¢ 
                <span class="mapping-highlight">Tilt Left/Right (Gamma)</span> â†’ Brightness â€¢ 
                <span class="mapping-highlight">Tilt Forward/Back (Beta)</span> â†’ Contrast
            </div>
            
            <div class="sensor-values">
                <div class="sensor-value">
                    <div class="value-label">Alpha (Â°)</div>
                    <div id="orientAlphaValue" class="value-number">0.00</div>
                </div>
                <div class="sensor-value">
                    <div class="value-label">Beta (Â°)</div>
                    <div id="orientBetaValue" class="value-number">0.00</div>
                </div>
                <div class="sensor-value">
                    <div class="value-label">Gamma (Â°)</div>
                    <div id="orientGammaValue" class="value-number">0.00</div>
                </div>
            </div>
            
            <div class="phone-visualization">
                <div class="compass">
                    <div id="compassNeedle" class="compass-needle"></div>
                    <div class="compass-center"></div>
                    <div class="compass-marker">
                        <span class="north">N</span><span class="east">E</span><span class="south">S</span><span class="west">W</span>
                    </div>
                </div>
            </div>

            <div class="sensor-adjust-controls" id="sensorAdjustControls">
                <h3>Sensor Effect Adjustments</h3>
                <!-- Brightness -->
                <div class="sensor-adjust-item">
                    <label for="brightnessAxisSelect">Brightness controlled by:</label>
                    <select id="brightnessAxisSelect" data-filter="brightness">
                        <option value="none">None</option>
                        <option value="alpha">Rotation (Alpha)</option>
                        <option value="beta">Tilt Fwd/Back (Beta)</option>
                        <option value="gamma">Tilt L/R (Gamma)</option>
                    </select>
                    <div class="control-label">
                        <span>Sensitivity:</span>
                        <span class="control-value" id="brightnessSensitivityValue">1.0</span>
                    </div>
                    <input type="range" id="brightnessSensitivitySlider" data-filter="brightness" class="sensor-adjust-slider" min="0.1" max="3" step="0.05" value="1.0">
                    <div class="control-label">
                        <span>Neutral Point (Â°):</span>
                        <span class="control-value" id="brightnessNeutralValue">0</span>
                    </div>
                    <input type="range" id="brightnessNeutralSlider" data-filter="brightness" class="sensor-adjust-slider" min="-180" max="180" step="1" value="0">
                </div>
                <!-- Saturation -->
                 <div class="sensor-adjust-item">
                    <label for="saturationAxisSelect">Saturation controlled by:</label>
                    <select id="saturationAxisSelect" data-filter="saturation">
                        <option value="none">None</option>
                        <option value="alpha">Rotation (Alpha)</option>
                        <option value="beta">Tilt Fwd/Back (Beta)</option>
                        <option value="gamma">Tilt L/R (Gamma)</option>
                    </select>
                    <div class="control-label">
                        <span>Sensitivity:</span>
                        <span class="control-value" id="saturationSensitivityValue">1.0</span>
                    </div>
                    <input type="range" id="saturationSensitivitySlider" data-filter="saturation" class="sensor-adjust-slider" min="0.1" max="3" step="0.05" value="1.0">
                    <div class="control-label">
                        <span>Neutral Point (Â°):</span>
                        <span class="control-value" id="saturationNeutralValue">0</span>
                    </div>
                    <input type="range" id="saturationNeutralSlider" data-filter="saturation" class="sensor-adjust-slider" min="-180" max="180" step="1" value="0">
                </div>
                <!-- Contrast -->
                 <div class="sensor-adjust-item">
                    <label for="contrastAxisSelect">Contrast controlled by:</label>
                    <select id="contrastAxisSelect" data-filter="contrast">
                        <option value="none">None</option>
                        <option value="alpha">Rotation (Alpha)</option>
                        <option value="beta">Tilt Fwd/Back (Beta)</option>
                        <option value="gamma">Tilt L/R (Gamma)</option>
                    </select>
                    <div class="control-label">
                        <span>Sensitivity:</span>
                        <span class="control-value" id="contrastSensitivityValue">1.0</span>
                    </div>
                    <input type="range" id="contrastSensitivitySlider" data-filter="contrast" class="sensor-adjust-slider" min="0.1" max="3" step="0.05" value="1.0">
                    <div class="control-label">
                        <span>Neutral Point (Â°):</span>
                        <span class="control-value" id="contrastNeutralValue">0</span>
                    </div>
                    <input type="range" id="contrastNeutralSlider" data-filter="contrast" class="sensor-adjust-slider" min="-180" max="180" step="1" value="0">
                </div>
                <button id="resetSensorAdjustmentsBtn" class="sensor-adjust-reset">Reset Sensor Adjustments</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const DOMElements = {
                videoPlayer: document.getElementById('videoPlayer'),
                videoContainer: document.getElementById('videoContainer'),
                playPauseBtn: document.getElementById('playPauseBtn'),
                loopBtn: document.getElementById('loopBtn'),
                fullscreenBtn: document.getElementById('fullscreenBtn'),
                fileInput: document.getElementById('fileInput'),
                fileName: document.getElementById('fileName'),
                progressContainer: document.getElementById('progressContainer'),
                progressBar: document.getElementById('progressBar'),
                currentTime: document.getElementById('currentTime'),
                duration: document.getElementById('duration'),
                volumeSlider: document.getElementById('volumeSlider'),
                placeholder: document.getElementById('placeholder'),
                controls: document.getElementById('controls'),
                loopInfo: document.getElementById('loopInfo'),
                // Filters
                brightnessSlider: document.getElementById('brightnessSlider'),
                saturationSlider: document.getElementById('saturationSlider'),
                contrastSlider: document.getElementById('contrastSlider'),
                brightnessValue: document.getElementById('brightnessValue'),
                saturationValue: document.getElementById('saturationValue'),
                contrastValue: document.getElementById('contrastValue'),
                resetFiltersBtn: document.getElementById('resetFiltersBtn'),
                // Sensors UI
                sensorToggleBtn: document.getElementById('sensorToggleBtn'),
                orientAlphaValue: document.getElementById('orientAlphaValue'),
                orientBetaValue: document.getElementById('orientBetaValue'),
                orientGammaValue: document.getElementById('orientGammaValue'),
                compassNeedle: document.getElementById('compassNeedle'),
                // Sensor Adjustment UI
                brightnessAxisSelect: document.getElementById('brightnessAxisSelect'),
                brightnessSensitivitySlider: document.getElementById('brightnessSensitivitySlider'),
                brightnessSensitivityValue: document.getElementById('brightnessSensitivityValue'),
                brightnessNeutralSlider: document.getElementById('brightnessNeutralSlider'),
                brightnessNeutralValue: document.getElementById('brightnessNeutralValue'),
                saturationAxisSelect: document.getElementById('saturationAxisSelect'),
                saturationSensitivitySlider: document.getElementById('saturationSensitivitySlider'),
                saturationSensitivityValue: document.getElementById('saturationSensitivityValue'),
                saturationNeutralSlider: document.getElementById('saturationNeutralSlider'),
                saturationNeutralValue: document.getElementById('saturationNeutralValue'),
                contrastAxisSelect: document.getElementById('contrastAxisSelect'),
                contrastSensitivitySlider: document.getElementById('contrastSensitivitySlider'),
                contrastSensitivityValue: document.getElementById('contrastSensitivityValue'),
                contrastNeutralSlider: document.getElementById('contrastNeutralSlider'),
                contrastNeutralValue: document.getElementById('contrastNeutralValue'),
                resetSensorAdjustmentsBtn: document.getElementById('resetSensorAdjustmentsBtn'),
            };

            // --- Player State ---
            let playerState = {
                isLooping: false,
                loopCount: 0,
                sensorsEnabled: false,
                deviceOrientationHandler: null, // To store the bound event handler
                lastTapTime: 0,
            };

            // --- Default Sensor Control Settings ---
            const defaultSensorControlSettings = {
                brightness: { axis: 'gamma', sensitivity: 0.833, neutral: 0 },
                saturation: { axis: 'alpha', sensitivity: 0.555, neutral: 0 },
                contrast: { axis: 'beta', sensitivity: 0.833, neutral: 0 }
            };
            let sensorControlSettings = JSON.parse(JSON.stringify(defaultSensorControlSettings)); // Deep copy


            // --- Utility Functions ---
            function formatTime(seconds) {
                if (isNaN(seconds) || seconds < 0) return '0:00';
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = Math.floor(seconds % 60);
                return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
            }

            function clamp(value, min, max) {
                return Math.max(min, Math.min(max, value));
            }

            function formatNumber(num) {
                return num != null ? num.toFixed(2) : '0.00';
            }
            
            // --- Load & Save Settings ---
            function loadSettings() {
                // Volume
                const savedVolume = localStorage.getItem('videoPlayerVolume');
                if (savedVolume) {
                    DOMElements.videoPlayer.volume = parseFloat(savedVolume);
                    DOMElements.volumeSlider.value = parseFloat(savedVolume);
                }
                // Filters
                DOMElements.brightnessSlider.value = localStorage.getItem('videoPlayerBrightness') || 100;
                DOMElements.saturationSlider.value = localStorage.getItem('videoPlayerSaturation') || 100;
                DOMElements.contrastSlider.value = localStorage.getItem('videoPlayerContrast') || 100;
                updateFilterUI();
                applyFilters();

                // Sensor Control Settings
                const savedSensorSettings = localStorage.getItem('videoPlayerSensorControls');
                if (savedSensorSettings) {
                    sensorControlSettings = JSON.parse(savedSensorSettings);
                }
                updateSensorAdjustmentUI();
            }

            function saveSensorControlSettings() {
                localStorage.setItem('videoPlayerSensorControls', JSON.stringify(sensorControlSettings));
            }

            // --- Core Player Logic ---
            function handleFileSelect() {
                const file = DOMElements.fileInput.files[0];
                if (file) {
                    const videoURL = URL.createObjectURL(file);
                    DOMElements.videoPlayer.src = videoURL;
                    DOMElements.fileName.textContent = file.name;
                    DOMElements.placeholder.style.display = 'none';
                    DOMElements.controls.style.display = 'flex';
                    playerState.loopCount = 0;
                    updateLoopInfo();
                    DOMElements.playPauseBtn.textContent = 'Play'; // Reset to Play
                }
            }

            function togglePlayPause() {
                if (DOMElements.videoPlayer.paused || DOMElements.videoPlayer.ended) {
                    DOMElements.videoPlayer.play();
                } else {
                    DOMElements.videoPlayer.pause();
                }
            }

            function updatePlayPauseButton() {
                DOMElements.playPauseBtn.textContent = (DOMElements.videoPlayer.paused || DOMElements.videoPlayer.ended) ? 'Play' : 'Pause';
            }

            function toggleLoop() {
                playerState.isLooping = !playerState.isLooping;
                DOMElements.videoPlayer.loop = playerState.isLooping;
                DOMElements.loopBtn.textContent = playerState.isLooping ? 'Loop: ON' : 'Loop: OFF';
                updateLoopInfo();
            }

            function updateLoopInfo() {
                if (playerState.isLooping) {
                    DOMElements.loopInfo.textContent = `Video has looped ${playerState.loopCount} time${playerState.loopCount === 1 ? '' : 's'}`;
                } else {
                    DOMElements.loopInfo.textContent = '';
                }
            }

            function handleTimeUpdate() {
                const { currentTime, duration } = DOMElements.videoPlayer;
                if (duration > 0) {
                    const percentage = (currentTime / duration) * 100;
                    DOMElements.progressBar.style.width = percentage + '%';
                }
                DOMElements.currentTime.textContent = formatTime(currentTime);
            }

            function handleLoadedMetadata() {
                DOMElements.duration.textContent = formatTime(DOMElements.videoPlayer.duration);
            }

            function handleProgressBarClick(e) {
                const progressContainerWidth = DOMElements.progressContainer.offsetWidth;
                const clickPosition = e.offsetX;
                DOMElements.videoPlayer.currentTime = (clickPosition / progressContainerWidth) * DOMElements.videoPlayer.duration;
            }

            function handleVolumeChange() {
                DOMElements.videoPlayer.volume = DOMElements.volumeSlider.value;
                localStorage.setItem('videoPlayerVolume', DOMElements.volumeSlider.value);
            }

            function handleVideoEnd() {
                if (playerState.isLooping) {
                    playerState.loopCount++;
                    updateLoopInfo();
                    // No need to explicitly call play() if video.loop is true
                }
                updatePlayPauseButton();
            }

            // --- Filter Logic ---
            function applyFilters() {
                const brightness = DOMElements.brightnessSlider.value;
                const saturation = DOMElements.saturationSlider.value;
                const contrast = DOMElements.contrastSlider.value;
                DOMElements.videoPlayer.style.filter = `brightness(${brightness}%) saturate(${saturation}%) contrast(${contrast}%)`;
            }

            function updateFilterUI() {
                DOMElements.brightnessValue.textContent = `${DOMElements.brightnessSlider.value}%`;
                DOMElements.saturationValue.textContent = `${DOMElements.saturationSlider.value}%`;
                DOMElements.contrastValue.textContent = `${DOMElements.contrastSlider.value}%`;
            }
            
            function handleFilterChange(event) {
                updateFilterUI();
                applyFilters();
                // Save individual filter to localStorage
                if (event.target === DOMElements.brightnessSlider) localStorage.setItem('videoPlayerBrightness', event.target.value);
                if (event.target === DOMElements.saturationSlider) localStorage.setItem('videoPlayerSaturation', event.target.value);
                if (event.target === DOMElements.contrastSlider) localStorage.setItem('videoPlayerContrast', event.target.value);
            }

            function resetFilters() {
                DOMElements.brightnessSlider.value = 100;
                DOMElements.saturationSlider.value = 100;
                DOMElements.contrastSlider.value = 100;
                localStorage.setItem('videoPlayerBrightness', 100);
                localStorage.setItem('videoPlayerSaturation', 100);
                localStorage.setItem('videoPlayerContrast', 100);
                updateFilterUI();
                applyFilters();
            }

            // --- Fullscreen Logic ---
            function toggleFullscreen() {
                const elem = DOMElements.videoContainer;
                if (!document.fullscreenElement) {
                    if (elem.requestFullscreen) elem.requestFullscreen().catch(err => console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`));
                    else if (elem.mozRequestFullScreen) elem.mozRequestFullScreen(); // Firefox
                    else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen(); // Chrome, Safari, Opera
                    else if (elem.msRequestFullscreen) elem.msRequestFullscreen(); // IE/Edge
                } else {
                    if (document.exitFullscreen) document.exitFullscreen().catch(err => console.error(err));
                    else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
                    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                    else if (document.msExitFullscreen) document.msExitFullscreen();
                }
            }

            function handleFullscreenChange() {
                if (document.fullscreenElement === DOMElements.videoContainer) {
                    DOMElements.videoContainer.classList.add('is-fullscreen');
                    DOMElements.fullscreenBtn.textContent = 'Exit Full';
                } else {
                    DOMElements.videoContainer.classList.remove('is-fullscreen');
                    DOMElements.fullscreenBtn.textContent = 'Fullscreen';
                }
            }

            function handleVideoDoubleTap(e) {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - playerState.lastTapTime;
                if (tapLength < 500 && tapLength > 0) { // Double tap
                    toggleFullscreen();
                    e.preventDefault(); // Prevent zoom or other default double-tap actions
                }
                playerState.lastTapTime = currentTime;
            }

            // --- Sensor Logic ---
            function updateSensorDisplay(alpha, beta, gamma) {
                DOMElements.orientAlphaValue.textContent = formatNumber(alpha);
                DOMElements.orientBetaValue.textContent = formatNumber(beta);
                DOMElements.orientGammaValue.textContent = formatNumber(gamma);
                if (DOMElements.compassNeedle) {
                    DOMElements.compassNeedle.style.transform = `rotate(${alpha || 0}deg)`;
                }
            }

            function mapOrientationToFilters(alpha, beta, gamma) {
                if (!playerState.sensorsEnabled) return;

                const sensorValues = { alpha: alpha || 0, beta: beta || 0, gamma: gamma || 0 };
                
                // Normalize alpha to be -180 to 180 for calculations if used
                // The actual alpha from event is 0-360.
                // If neutral is 0, this means "north" is neutral.
                // If neutral is 180, "south" is neutral.
                // It's often simpler to let users adjust neutral on the 0-360 scale if alpha is directly used.
                // For now, we'll use the 0-360 range and let neutral point define the center.
                // A common way to handle cyclic values like alpha (0-360 for compass):
                // deviation = (value - neutral + 540) % 360 - 180; // gives shortest angle, -180 to 180
                
                ['brightness', 'saturation', 'contrast'].forEach(filterType => {
                    const config = sensorControlSettings[filterType];
                    if (config.axis === 'none' || !config.enabled) return; // Renamed config.enabled to just check axis !== 'none'

                    let sensorVal = sensorValues[config.axis];
                    let deviation;

                    if (config.axis === 'alpha') { // Cyclic value
                        deviation = (sensorVal - config.neutral + 540) % 360 - 180;
                    } else { // Non-cyclic like beta, gamma
                        deviation = sensorVal - config.neutral;
                    }
                    
                    const change = deviation * config.sensitivity;
                    const newFilterValue = clamp(100 + change, 25, 200);

                    DOMElements[filterType + 'Slider'].value = newFilterValue;
                });
                updateFilterUI(); // Update text values like "120%"
                applyFilters(); // Apply CSS filters
            }
            
            playerState.deviceOrientationHandler = (event) => {
                if (!playerState.sensorsEnabled) return;
                const { alpha, beta, gamma } = event;
                updateSensorDisplay(alpha, beta, gamma);
                mapOrientationToFilters(alpha, beta, gamma);
            };

            function enableSensors() {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                window.addEventListener('deviceorientation', playerState.deviceOrientationHandler);
                                playerState.sensorsEnabled = true;
                                DOMElements.sensorToggleBtn.textContent = 'Disable Sensors';
                                DOMElements.sensorToggleBtn.classList.add('active');
                            } else {
                                alert('Motion sensor permission denied.');
                                playerState.sensorsEnabled = false;
                                DOMElements.sensorToggleBtn.textContent = 'Enable Sensors';
                                DOMElements.sensorToggleBtn.classList.remove('active');
                            }
                        })
                        .catch(error => {
                            console.error('Error requesting device orientation permission:', error);
                            alert('Could not request sensor permissions.');
                            playerState.sensorsEnabled = false;
                        });
                } else if ('DeviceOrientationEvent' in window) {
                    // For non-iOS 13+ devices
                    window.addEventListener('deviceorientation', playerState.deviceOrientationHandler);
                    playerState.sensorsEnabled = true;
                    DOMElements.sensorToggleBtn.textContent = 'Disable Sensors';
                    DOMElements.sensorToggleBtn.classList.add('active');
                } else {
                    alert('Device orientation not supported on this device/browser.');
                    DOMElements.sensorToggleBtn.textContent = 'Not Supported';
                    DOMElements.sensorToggleBtn.disabled = true;
                }
            }

            function disableSensors() {
                if (playerState.deviceOrientationHandler) {
                    window.removeEventListener('deviceorientation', playerState.deviceOrientationHandler);
                }
                playerState.sensorsEnabled = false;
                DOMElements.sensorToggleBtn.textContent = 'Enable Sensors';
                DOMElements.sensorToggleBtn.classList.remove('active');
                // Optionally reset filters to manual state if desired
                // resetFilters(); 
            }

            function toggleSensors() {
                if (playerState.sensorsEnabled) {
                    disableSensors();
                } else {
                    enableSensors();
                }
            }

            // --- Sensor Adjustment UI Logic ---
            function updateSensorAdjustmentUI() {
                ['brightness', 'saturation', 'contrast'].forEach(filterType => {
                    const config = sensorControlSettings[filterType];
                    DOMElements[filterType + 'AxisSelect'].value = config.axis;
                    DOMElements[filterType + 'SensitivitySlider'].value = config.sensitivity;
                    DOMElements[filterType + 'SensitivityValue'].textContent = parseFloat(config.sensitivity).toFixed(2);
                    DOMElements[filterType + 'NeutralSlider'].value = config.neutral;
                    DOMElements[filterType + 'NeutralValue'].textContent = config.neutral;
                });
            }

            function handleSensorAdjustmentChange(event) {
                const filterType = event.target.dataset.filter;
                if (!filterType) return;

                const axisSelect = DOMElements[filterType + 'AxisSelect'];
                const sensitivitySlider = DOMElements[filterType + 'SensitivitySlider'];
                const neutralSlider = DOMElements[filterType + 'NeutralSlider'];

                sensorControlSettings[filterType].axis = axisSelect.value;
                sensorControlSettings[filterType].sensitivity = parseFloat(sensitivitySlider.value);
                sensorControlSettings[filterType].neutral = parseInt(neutralSlider.value);
                
                updateSensorAdjustmentUI(); // Update display values
                saveSensorControlSettings();
            }
            
            function resetSensorAdjustments() {
                sensorControlSettings = JSON.parse(JSON.stringify(defaultSensorControlSettings)); // Deep copy
                updateSensorAdjustmentUI();
                saveSensorControlSettings();
                 // If sensors are active, this will immediately apply default sensor behavior to filters
                if (playerState.sensorsEnabled) {
                    // To reflect this reset immediately on filters if sensors are active,
                    // one might need to simulate a sensor event or call mapOrientationToFilters
                    // with current (or zero) sensor values. For simplicity, it'll take effect on next sensor event.
                }
            }


            // --- Event Listeners ---
            function setupEventListeners() {
                DOMElements.fileInput.addEventListener('change', handleFileSelect);
                DOMElements.playPauseBtn.addEventListener('click', togglePlayPause);
                DOMElements.loopBtn.addEventListener('click', toggleLoop);
                DOMElements.fullscreenBtn.addEventListener('click', toggleFullscreen);
                
                DOMElements.videoPlayer.addEventListener('play', updatePlayPauseButton);
                DOMElements.videoPlayer.addEventListener('pause', updatePlayPauseButton);
                DOMElements.videoPlayer.addEventListener('ended', handleVideoEnd);
                DOMElements.videoPlayer.addEventListener('timeupdate', handleTimeUpdate);
                DOMElements.videoPlayer.addEventListener('loadedmetadata', handleLoadedMetadata);
                DOMElements.videoPlayer.addEventListener('touchend', handleVideoDoubleTap);


                DOMElements.progressContainer.addEventListener('click', handleProgressBarClick);
                DOMElements.volumeSlider.addEventListener('input', handleVolumeChange);

                // Filters
                [DOMElements.brightnessSlider, DOMElements.saturationSlider, DOMElements.contrastSlider].forEach(slider => {
                    slider.addEventListener('input', handleFilterChange);
                });
                DOMElements.resetFiltersBtn.addEventListener('click', resetFilters);

                // Fullscreen API events
                document.addEventListener('fullscreenchange', handleFullscreenChange);
                document.addEventListener('webkitfullscreenchange', handleFullscreenChange); // Safari, Chrome
                document.addEventListener('mozfullscreenchange', handleFullscreenChange);    // Firefox
                document.addEventListener('MSFullscreenChange', handleFullscreenChange);     // IE/Edge

                // Sensor Toggle
                DOMElements.sensorToggleBtn.addEventListener('click', toggleSensors);

                // Sensor Adjustment Controls
                [DOMElements.brightnessAxisSelect, DOMElements.brightnessSensitivitySlider, DOMElements.brightnessNeutralSlider,
                 DOMElements.saturationAxisSelect, DOMElements.saturationSensitivitySlider, DOMElements.saturationNeutralSlider,
                 DOMElements.contrastAxisSelect, DOMElements.contrastSensitivitySlider, DOMElements.contrastNeutralSlider]
                 .forEach(el => el.addEventListener('input', handleSensorAdjustmentChange)); // 'input' for sliders, 'change' for select (input works for both)
                
                DOMElements.resetSensorAdjustmentsBtn.addEventListener('click', resetSensorAdjustments);
            }

            // --- Initialization ---
            function init() {
                loadSettings();
                setupEventListeners();
                updateSensorDisplay(null, null, null); // Initial sensor display reset
            }

            init();
        });
    </script>
</body>
</html>
