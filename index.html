<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Sensor Video Processor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #121212; color: #f0f0f0;
            min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 10px;
        }
        .container {
            width: 100%; max-width: 500px; margin: 0 auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); border-radius: 8px;
            overflow: hidden; background-color: #1e1e1e;
        }
        .player-header { padding: 12px 16px; background-color: #2d2d2d; text-align: center; }
        .player-header h1 { font-size: 18px; font-weight: 600; }

        .mode-switcher { display: flex; background-color: #2d2d2d; border-bottom: 1px solid #333;}
        .mode-switcher button {
            flex: 1; padding: 12px; background-color: #2d2d2d; color: #aaa;
            border: none; border-bottom: 3px solid transparent; font-size: 14px; cursor: pointer;
        }
        .mode-switcher button.active { color: #2c7be5; border-bottom-color: #2c7be5; font-weight: bold; }
        .mode-switcher button:hover:not(.active) { background-color: #383838; }

        .video-container { position: relative; width: 100%; background-color: #000; }
        video { width: 100%; display: block; }
        
        .video-container.fullscreen, .point-cloud-container.fullscreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; background-color: #000;
            display: flex; align-items: center; justify-content: center;
        }
        .video-container.fullscreen video, .point-cloud-container.fullscreen #pointCloudCanvas {
            max-width: 100%; max-height: 100%; width: auto !important; height: auto !important; object-fit: contain;
        }
        .controls-overlay { /* For video fullscreen controls */
            position: absolute; bottom: 0; left: 0; right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            padding: 20px 10px 10px; opacity: 0; transition: opacity 0.3s ease; z-index: 10000;
        }
        .video-container.fullscreen:hover .controls-overlay,
        .video-container.fullscreen .controls-overlay.active { opacity: 1; }
        
        .controls, .filter-controls, .point-cloud-params-container {
            padding: 12px 16px; display: flex; flex-direction: column; gap: 12px;
        }
        .filter-controls, .point-cloud-params-container { background-color: #2a2a2a; border-top: 1px solid #333; }
        .main-controls { display: flex; justify-content: space-between; align-items: center; }
        
        .file-controls {
            display: flex; flex-direction: column; gap: 8px; padding: 16px; background-color: #1e1e1e;
        }
        button {
            background-color: #2c7be5; color: white; border: none; border-radius: 4px;
            padding: 10px 15px; font-size: 14px; cursor: pointer; transition: background-color 0.2s;
        }
        button:hover { background-color: #1a68d1; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        .toggle-button { min-width: 100px; }
        input[type="file"] { display: none; }
        .file-label {
            display: inline-block; background-color: #4caf50; color: white; border-radius: 4px;
            padding: 10px 15px; font-size: 14px; cursor: pointer; transition: background-color 0.2s;
            text-align: center;
        }
        .file-label:hover { background-color: #3e8e41; }
        .file-name { padding: 5px; color: #aaa; font-size: 14px; text-align: center; word-break: break-all; }
        
        .progress-container {
            width: 100%; height: 5px; background-color: #333; border-radius: 5px;
            overflow: hidden; margin-top: 8px; cursor: pointer;
        }
        .progress-bar { height: 100%; background-color: #2c7be5; width: 0; transition: width 0.1s; }
        .time-display { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; margin-top: 5px; }
        
        .volume-container { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        .volume-icon { color: #aaa; width: 20px; text-align: center; }
        .volume-slider {
            flex: 1; -webkit-appearance: none; height: 5px; border-radius: 5px; background: #333; outline: none;
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 15px; height: 15px;
            border-radius: 50%; background: #2c7be5; cursor: pointer;
        }
        .volume-slider::-moz-range-thumb { /* For Firefox */
            width: 15px; height: 15px; border-radius: 50%; background: #2c7be5; cursor: pointer; border: none;
        }
        .placeholder-message { padding: 30px; text-align: center; color: #888; }
        .loop-info { font-size: 12px; color: #aaa; text-align: center; margin-top: 5px; }
        
        .filter-control { margin-bottom: 12px; }
        .filter-control:last-child { margin-bottom: 0; }
        .filter-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; color: #ddd; }
        .filter-value { color: #2c7be5; font-weight: 500; }
        .filter-slider {
            width: 100%; -webkit-appearance: none; height: 5px; border-radius: 5px; background: #333; outline: none;
        }
        .filter-slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 15px; height: 15px;
            border-radius: 50%; background: #2c7be5; cursor: pointer;
        }
         .filter-slider::-moz-range-thumb { /* For Firefox */
            width: 15px; height: 15px; border-radius: 50%; background: #2c7be5; cursor: pointer; border: none;
        }
        .filter-reset {
            background-color: #555; margin-top: 10px; width: 100%;
            font-size: 13px; padding: 8px;
        }
        .filter-reset:hover { background-color: #666; }
        
        .sensor-section {
            background-color: #1e1e1e; border-radius: 0 0 8px 8px; padding: 15px;
            border-top: 1px solid #333;
        }
        .sensor-heading { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .sensor-title { font-size: 16px; font-weight: 600; }
        .sensor-toggle {
            background-color: #2c7be5; color: white; border: none; border-radius: 4px;
            padding: 6px 12px; font-size: 14px; cursor: pointer;
        }
        .sensor-toggle.active { background-color: #4caf50; }
        .sensor-values { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
        .sensor-value { background-color: #2d2d2d; padding: 8px; border-radius: 6px; text-align: center; }
        .value-label { font-size: 12px; color: #aaa; margin-bottom: 5px; }
        .value-number { font-size: 16px; font-weight: 500; font-family: monospace; color: #2c7be5; }
        .compass {
            width: 100px; height: 100px; margin: 10px auto; position: relative; border-radius: 50%;
            background-color: #2d2d2d; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 8px rgba(0,0,0,0.4) inset;
        }
        .compass-needle {
            position: absolute; width: 3px; height: 70px;
            background: linear-gradient(to bottom, #f44336 50%, #fff 50%);
            transform-origin: center center; transition: transform 0.1s ease;
        }
        .compass-center { width: 10px; height: 10px; background-color: #333; border-radius: 50%; z-index: 1;}
        .compass-marker span { position: absolute; width: 18px; text-align: center; font-weight: bold; color: #ddd; font-size: 12px;}
        .compass-marker .north { top: 5px; left: calc(50% - 9px); }
        .compass-marker .east { right: 5px; top: calc(50% - 9px); }
        .compass-marker .south { bottom: 5px; left: calc(50% - 9px); }
        .compass-marker .west { left: 5px; top: calc(50% - 9px); }

        .mapping-info { font-size: 13px; color: #aaa; margin: 10px 0; text-align: center; line-height: 1.4; }
        .mapping-highlight { color: #2c7be5; font-weight: 500; }
        .sensor-configuration { margin-top: 15px; border-top: 1px solid #333; padding-top: 15px; }
        .sensor-config-title { font-size: 14px; font-weight: 600; margin-bottom: 10px; color: #ddd; }
        .sensor-config-controls { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .sensor-config-control { background-color: #2d2d2d; padding: 10px; border-radius: 6px; }
        .config-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; }
        .config-value { color: #2c7be5; font-weight: 500; }
        .config-slider { /* Re-use filter-slider styles */
            width: 100%; -webkit-appearance: none; height: 5px; border-radius: 5px; background: #333; outline: none;
        }
        .config-slider::-webkit-slider-thumb { /* Re-use filter-slider styles */
            -webkit-appearance: none; appearance: none; width: 15px; height: 15px;
            border-radius: 50%; background: #2c7be5; cursor: pointer;
        }
        .config-slider::-moz-range-thumb { /* For Firefox */
            width: 15px; height: 15px; border-radius: 50%; background: #2c7be5; cursor: pointer; border: none;
        }
        .sensor-actions { display: flex; gap: 10px; margin-top: 10px; }
        .sensor-action-btn {
            flex: 1; padding: 8px; font-size: 13px; background-color: #555;
        }
        .sensor-action-btn:hover { background-color: #666; }

        .point-cloud-container { width:100%; /* Container for canvas for fullscreen */ }
        #pointCloudCanvas {
            width: 100%; background-color: #050505;
            /* margin-top: 10px; No, part of pointCloudModeContent */
            border: 1px solid #333; display: block; /* Important for layout */
            cursor: pointer; /* For double tap fullscreen */
        }

        /* New CSS for sensor mapping UI */
        .mapping-container {
            background-color: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-top: 1px solid #333;
        }
        .mapping-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .mapping-title {
            font-size: 16px;
            font-weight: 600;
        }
        .mapping-view-toggle {
            display: flex;
            border-radius: 4px;
            overflow: hidden;
        }
        .mapping-view-toggle button {
            padding: 6px 12px;
            background-color: #333;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 12px;
        }
        .mapping-view-toggle button.active {
            background-color: #2c7be5;
            color: white;
        }
        .mapping-list {
            margin-bottom: 15px;
        }
        .mapping-item {
            background-color: #2d2d2d;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #2c7be5;
        }
        .mapping-item.disabled {
            border-left-color: #555;
            opacity: 0.7;
        }
        .mapping-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .mapping-connection {
            display: flex;
            align-items: center;
        }
        .mapping-sensor {
            font-weight: 500;
        }
        .mapping-arrow {
            margin: 0 8px;
            color: #2c7be5;
        }
        .mapping-effect {
            font-weight: 500;
        }
        .mapping-actions {
            display: flex;
            gap: 8px;
        }
        .mapping-action-btn {
            background-color: #444;
            color: #ddd;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        .mapping-action-btn:hover {
            background-color: #555;
        }
        .mapping-action-btn.delete {
            background-color: #6e3a3a;
        }
        .mapping-action-btn.delete:hover {
            background-color: #834545;
        }
        .mapping-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #aaa;
        }
        .mapping-detail {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .mapping-detail-icon {
            color: #2c7be5;
            font-size: 10px;
        }
        .mapping-add-btn {
            width: 100%;
            background-color: #2d2d2d;
            color: #aaa;
            border: 1px dashed #555;
            border-radius: 6px;
            padding: 12px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .mapping-add-btn:hover {
            background-color: #333;
            border-color: #2c7be5;
            color: #fff;
        }
        .mapping-add-icon {
            font-size: 16px;
        }

        /* Mapping Grid View */
        .mapping-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .mapping-grid-item {
            background-color: #2d2d2d;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #444;
        }
        .mapping-grid-item.disabled {
            opacity: 0.7;
        }
        .mapping-grid-header {
            background-color: #333;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .mapping-grid-sensor {
            font-weight: 500;
            font-size: 14px;
        }
        .mapping-grid-actions {
            display: flex;
            gap: 5px;
        }
        .mapping-grid-action {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            padding: 3px;
            font-size: 12px;
        }
        .mapping-grid-action:hover {
            color: #fff;
        }
        .mapping-grid-effect {
            padding: 10px;
            text-align: center;
            font-weight: 500;
            border-bottom: 1px solid #444;
        }
        .mapping-grid-details {
            padding: 10px;
            font-size: 12px;
            color: #aaa;
        }
        .mapping-grid-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }
        .mapping-grid-value {
            color: #2c7be5;
        }
        .mapping-grid-add {
            background-color: #2d2d2d;
            border-radius: 6px;
            border: 1px dashed #555;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mapping-grid-add:hover {
            background-color: #333;
            border-color: #2c7be5;
        }
        .mapping-grid-add-icon {
            font-size: 24px;
            margin-bottom: 8px;
            color: #2c7be5;
        }
        .mapping-grid-add-text {
            color: #aaa;
        }

        /* Mapping Modal */
        .mapping-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            padding: 20px;
        }
        .mapping-modal {
            background-color: #2d2d2d;
            border-radius: 8px;
            width: 100%;
            max-width: 460px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        .mapping-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }
        .mapping-modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        .mapping-modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #aaa;
            cursor: pointer;
        }
        .mapping-modal-close:hover {
            color: #fff;
        }
        .mapping-form-group {
            margin-bottom: 15px;
        }
        .mapping-form-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #ddd;
        }
        .mapping-form-description {
            font-size: 12px;
            color: #888;
            margin-top: 3px;
        }
        .mapping-form-select, .mapping-form-input {
            width: 100%;
            padding: 8px 12px;
            background-color: #444;
            border: 1px solid #555;
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
        }
        .mapping-form-row {
            display: flex;
            gap: 10px;
        }
        .mapping-form-col {
            flex: 1;
        }
        .mapping-slider-container {
            margin-top: 20px;
        }
        .mapping-slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .mapping-slider-label {
            font-size: 14px;
            color: #ddd;
        }
        .mapping-slider-value {
            font-size: 14px;
            color: #2c7be5;
            font-weight: 500;
        }
        .mapping-slider {
            width: 100%;
            -webkit-appearance: none;
            height: 5px;
            border-radius: 5px;
            background: #555;
            outline: none;
            margin-bottom: 15px;
        }
        .mapping-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px; height: 15px;
            border-radius: 50%;
            background: #2c7be5;
            cursor: pointer;
        }
        .mapping-slider::-moz-range-thumb {
            width: 15px; height: 15px;
            border-radius: 50%;
            background: #2c7be5;
            cursor: pointer;
            border: none;
        }
        .mapping-checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }
        .mapping-checkbox {
            width: 16px;
            height: 16px;
        }
        .mapping-checkbox-label {
            font-size: 14px;
            color: #ddd;
        }
        .mapping-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }
        .mapping-modal-btn {
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            border: none;
        }
        .mapping-modal-cancel {
            background-color: #555;
            color: #fff;
        }
        .mapping-modal-cancel:hover {
            background-color: #666;
        }
        .mapping-modal-save {
            background-color: #2c7be5;
            color: #fff;
        }
        .mapping-modal-save:hover {
            background-color: #1a68d1;
        }

        /* Audio Level Meter */
        .audio-level-container {
            background-color: #2d2d2d;
            border-radius: 6px;
            padding: 8px;
            margin-top: 10px;
        }
        .audio-level-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .audio-level-title {
            font-size: 12px;
            color: #aaa;
        }
        .audio-level-value {
            font-size: 12px;
            color: #2c7be5;
            font-weight: 500;
        }
        .audio-level-meter {
            height: 8px;
            background-color: #444;
            border-radius: 4px;
            overflow: hidden;
        }
        .audio-level-bar {
            height: 100%;
            background-color: #2c7be5;
            width: 0%;
            transition: width 0.1s;
        }

        /* Light Sensor */
        .light-sensor-container {
            background-color: #2d2d2d;
            border-radius: 6px;
            padding: 8px;
            margin-top: 10px;
        }
        .light-sensor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .light-sensor-title {
            font-size: 12px;
            color: #aaa;
        }
        .light-sensor-value {
            font-size: 12px;
            color: #2c7be5;
            font-weight: 500;
        }
        .light-sensor-icon {
            font-size: 18px;
            margin-right: 8px;
            color: #f8c555;
        }

        /* Testing Mode Controls */
        .testing-mode-container {
            margin-top: 15px;
            padding: 10px;
            background-color: #2d2d2d;
            border-radius: 6px;
            border-left: 3px solid #f8c555;
        }
        .testing-mode-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .testing-mode-title {
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        .testing-mode-icon {
            margin-right: 8px;
            color: #f8c555;
        }
        .testing-mode-toggle {
            background-color: #444;
            border: none;
            color: #ddd;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        .testing-mode-toggle:hover {
            background-color: #555;
        }
        .testing-mode-toggle.active {
            background-color: #f8c555;
            color: #333;
        }
        .testing-mode-description {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 8px;
        }
        .testing-mode-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .testing-mode-control {
            background-color: #333;
            padding: 8px;
            border-radius: 4px;
        }
        .testing-mode-control-label {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
        }
        .testing-mode-slider {
            width: 100%;
        }
        
        @media (max-width: 480px) {
            .controls, .filter-controls, .point-cloud-params-container { padding: 10px; gap: 10px;}
            button, .file-label { padding: 8px 12px; font-size: 13px; }
            .toggle-button { min-width: 80px; }
            .sensor-config-controls { grid-template-columns: 1fr; } /* Stack sensor config on small screens */
            .mapping-grid { grid-template-columns: 1fr; } /* Single column on small screens */
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="player-header">
            <h1>Enhanced Sensor Video Processor</h1>
        </div>

        <div class="mode-switcher">
            <button id="showVideoPlayerModeBtn" class="active">Video Player</button>
            <button id="showPointCloudModeBtn">Point Cloud</button>
            <button id="showMappingsModeBtn">Sensor Mappings</button>
        </div>

        <!-- Video Player Mode Content -->
        <div id="videoPlayerModeContent">
            <div class="video-container" id="mainVideoContainer">
                <video id="videoPlayer" playsinline webkit-playsinline></video>
                <div class="controls-overlay" id="fullscreenControlsOverlay">
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBarFullscreen"></div>
                    </div>
                    <div class="main-controls">
                        <button id="playPauseFullscreen" class="toggle-button">Play</button>
                        <button id="exitVideoFullscreenBtn" class="toggle-button">Exit Full</button>
                    </div>
                </div>
            </div>
            
            <div id="videoPlaceholder" class="placeholder-message">
                <p>Select a video file to play</p>
            </div>
            
            <div class="controls" id="videoPlayerControls">
                <div class="progress-container" id="mainProgressContainer">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>
                <div class="main-controls">
                    <button id="playPauseBtn" class="toggle-button">Play</button>
                    <button id="videoFullscreenBtn" class="toggle-button">Fullscreen</button>
                    <button id="loopBtn" class="toggle-button">Loop: ON</button>
                </div>
                <div class="volume-container">
                    <div class="volume-icon">🔊</div>
                    <input type="range" min="0" max="1" step="0.1" value="1" class="volume-slider" id="volumeSlider">
                </div>
                <div class="loop-info" id="loopInfo"></div>
            </div>
            
            <div class="filter-controls" id="videoFilterControls">
                 <div class="filter-control">
                    <div class="filter-label"><span>Brightness</span><span class="filter-value" id="brightnessValue">100%</span></div>
                    <input type="range" min="25" max="200" value="100" class="filter-slider" id="brightnessSlider">
                </div>
                <div class="filter-control">
                    <div class="filter-label"><span>Saturation</span><span class="filter-value" id="saturationValue">100%</span></div>
                    <input type="range" min="25" max="200" value="100" class="filter-slider" id="saturationSlider">
                </div>
                <div class="filter-control">
                    <div class="filter-label"><span>Contrast</span><span class="filter-value" id="contrastValue">100%</span></div>
                    <input type="range" min="25" max="200" value="100" class="filter-slider" id="contrastSlider">
                </div>
                <div class="filter-control">
                    <div class="filter-label"><span>Hue Rotate</span><span class="filter-value" id="hueRotateValue">0°</span></div>
                    <input type="range" min="0" max="360" value="0" class="filter-slider" id="hueRotateSlider">
                </div>
                <div class="filter-control">
                    <div class="filter-label"><span>Blur</span><span class="filter-value" id="blurValue">0px</span></div>
                    <input type="range" min="0" max="20" value="0" class="filter-slider" id="blurSlider">
                </div>
                <button id="resetFiltersBtn" class="filter-reset">Reset All Filters</button>
            </div>
        </div>

        <!-- Point Cloud Mode Content -->
        <div id="pointCloudModeContent" class="hidden">
            <div class="point-cloud-container" id="mainPointCloudContainer">
                 <canvas id="pointCloudCanvas"></canvas>
            </div>
            <div class="point-cloud-params-container" id="pointCloudParams">
                <div class="filter-control">
                    <div class="filter-label"><span>Point Density</span><span class="filter-value" id="densityValue">32</span></div>
                    <input type="range" min="8" max="128" value="32" step="1" class="filter-slider" id="densitySlider">
                </div>
                <div class="filter-control">
                    <div class="filter-label"><span>Displacement Scale</span><span class="filter-value" id="displacementValue">50</span></div>
                    <input type="range" min="0" max="200" value="50" step="1" class="filter-slider" id="displacementSlider">
                </div>
                 <div class="filter-control">
                    <div class="filter-label"><span>Point Size</span><span class="filter-value" id="pointSizeValue">3</span></div>
                    <input type="range" min="1" max="10" value="3" step="1" class="filter-slider" id="pointSizeSlider">
                </div>
                <div class="filter-control">
                    <div class="filter-label"><span>Tilt Sensitivity</span><span class="filter-value" id="tiltSensitivityValue">10</span></div>
                    <input type="range" min="0" max="50" value="10" step="1" class="filter-slider" id="tiltSensitivitySlider">
                </div>
            </div>
        </div>
        
        <!-- Sensor Mappings Mode Content -->
        <div id="sensorMappingsModeContent" class="hidden">
            <div class="mapping-container">
                <div class="mapping-header">
                    <div class="mapping-title">Sensor to Effect Mappings</div>
                    <div class="mapping-view-toggle">
                        <button id="listViewBtn" class="active">List</button>
                        <button id="gridViewBtn">Grid</button>
                    </div>
                </div>
                
                <!-- List View -->
                <div id="mappingListView" class="mapping-list">
                    <!-- Each mapping item will be generated by JavaScript -->
                    <!-- Example mapping item structure: -->
                    <div class="mapping-item">
                        <div class="mapping-item-header">
                            <div class="mapping-connection">
                                <span class="mapping-sensor">Rotation (Alpha)</span>
                                <span class="mapping-arrow">→</span>
                                <span class="mapping-effect">Saturation</span>
                            </div>
                            <div class="mapping-actions">
                                <button class="mapping-action-btn">Disable</button>
                                <button class="mapping-action-btn">Edit</button>
                                <button class="mapping-action-btn delete">Delete</button>
                            </div>
                        </div>
                        <div class="mapping-details">
                            <div class="mapping-detail">
                                <span class="mapping-detail-icon">⚙️</span>
                                <span>Sensitivity: 1.0</span>
                            </div>
                            <div class="mapping-detail">
                                <span class="mapping-detail-icon">🔄</span>
                                <span>Normal</span>
                            </div>
                            <div class="mapping-detail">
                                <span class="mapping-detail-icon">📊</span>
                                <span>Range: 50% - 150%</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Grid View -->
                <div id="mappingGridView" class="mapping-grid hidden">
                    <!-- Example grid item structure: -->
                    <div class="mapping-grid-item">
                        <div class="mapping-grid-header">
                            <div class="mapping-grid-sensor">Rotation (Alpha)</div>
                            <div class="mapping-grid-actions">
                                <button class="mapping-grid-action">⚡</button>
                                <button class="mapping-grid-action">✏️</button>
                                <button class="mapping-grid-action">🗑️</button>
                            </div>
                        </div>
                        <div class="mapping-grid-effect">Saturation</div>
                        <div class="mapping-grid-details">
                            <div class="mapping-grid-detail">
                                <span>Sensitivity:</span>
                                <span class="mapping-grid-value">1.0</span>
                            </div>
                            <div class="mapping-grid-detail">
                                <span>Invert:</span>
                                <span class="mapping-grid-value">No</span>
                            </div>
                            <div class="mapping-grid-detail">
                                <span>Range:</span>
                                <span class="mapping-grid-value">50% - 150%</span>
                            </div>
                        </div>
                    </div>
                    <!-- Add New Button for Grid View -->
                    <div class="mapping-grid-add" id="addMappingBtnGrid">
                        <div class="mapping-grid-add-icon">+</div>
                        <div class="mapping-grid-add-text">Add New Mapping</div>
                    </div>
                </div>
                
                <!-- Add Button for List View -->
                <button id="addMappingBtn" class="mapping-add-btn">
                    <span class="mapping-add-icon">+</span>
                    <span>Add New Sensor Mapping</span>
                </button>
                
                <!-- Additional Sensor Information -->
                <div class="audio-level-container">
                    <div class="audio-level-header">
                        <div class="audio-level-title">Microphone Level</div>
                        <div class="audio-level-value" id="micLevelValue">0 dB</div>
                    </div>
                    <div class="audio-level-meter">
                        <div class="audio-level-bar" id="micLevelBar"></div>
                    </div>
                </div>
                
                <div class="light-sensor-container">
                    <div class="light-sensor-header">
                        <div class="light-sensor-title">
                            <span class="light-sensor-icon">☀️</span>
                            <span>Ambient Light</span>
                        </div>
                        <div class="light-sensor-value" id="lightLevelValue">Unknown</div>
                    </div>
                </div>
                
                <!-- Testing Mode -->
                <div class="testing-mode-container">
                    <div class="testing-mode-header">
                        <div class="testing-mode-title">
                            <span class="testing-mode-icon">🧪</span>
                            <span>Testing Mode</span>
                        </div>
                        <button id="testingModeToggle" class="testing-mode-toggle">Enable</button>
                    </div>
                    <div class="testing-mode-description">
                        Manually adjust sensor values to test your mappings without using actual device sensors.
                    </div>
                    <div id="testingControls" class="testing-mode-controls hidden">
                        <div class="testing-mode-control">
                            <div class="testing-mode-control-label">Alpha (Rotation)</div>
                            <input type="range" min="0" max="360" value="180" class="mapping-slider" id="testAlphaSlider">
                        </div>
                        <div class="testing-mode-control">
                            <div class="testing-mode-control-label">Beta (Tilt F/B)</div>
                            <input type="range" min="-90" max="90" value="0" class="mapping-slider" id="testBetaSlider">
                        </div>
                        <div class="testing-mode-control">
                            <div class="testing-mode-control-label">Gamma (Tilt L/R)</div>
                            <input type="range" min="-90" max="90" value="0" class="mapping-slider" id="testGammaSlider">
                        </div>
                        <div class="testing-mode-control">
                            <div class="testing-mode-control-label">Microphone Level</div>
                            <input type="range" min="0" max="100" value="30" class="mapping-slider" id="testMicSlider">
                        </div>
                        <div class="testing-mode-control">
                            <div class="testing-mode-control-label">Light Level</div>
                            <input type="range" min="0" max="1000" value="500" class="mapping-slider" id="testLightSlider">
                        </div>
                        <div class="testing-mode-control">
                            <div class="testing-mode-control-label">Acceleration X</div>
                            <input type="range" min="-10" max="10" value="0" step="0.1" class="mapping-slider" id="testAccelXSlider">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Mapping Edit/Add Modal -->
        <div id="mappingModal" class="mapping-modal-overlay hidden">
            <div class="mapping-modal">
                <div class="mapping-modal-header">
                    <div class="mapping-modal-title">Edit Mapping</div>
                    <button class="mapping-modal-close" id="closeModalBtn">×</button>
                </div>
                <div class="mapping-form-group">
                    <label class="mapping-form-label">Sensor Input</label>
                    <select class="mapping-form-select" id="modalSensorSelect">
                        <option value="alpha">Rotation (Alpha)</option>
                        <option value="beta">Tilt Forward/Back (Beta)</option>
                        <option value="gamma">Tilt Left/Right (Gamma)</option>
                        <option value="light">Ambient Light</option>
                        <option value="mic">Microphone Level</option>
                        <option value="accelX">Acceleration X</option>
                        <option value="accelY">Acceleration Y</option>
                        <option value="accelZ">Acceleration Z</option>
                    </select>
                    <div class="mapping-form-description" id="modalSensorDescription">
                        Device rotation around z-axis (compass direction)
                    </div>
                </div>
                <div class="mapping-form-group">
                    <label class="mapping-form-label">Effect Output</label>
                    <select class="mapping-form-select" id="modalEffectSelect">
                        <option value="brightness">Brightness</option>
                        <option value="contrast">Contrast</option>
                        <option value="saturation">Saturation</option>
                        <option value="hueRotate">Hue Rotation</option>
                        <option value="blur">Blur</option>
                        <option value="sepia">Sepia</option>
                        <option value="playbackRate">Playback Speed</option>
                        <option value="pointCloudDisplacement">Point Cloud Displacement</option>
                    </select>
                    <div class="mapping-form-description" id="modalEffectDescription">
                        Video brightness filter (25% - 200%)
                    </div>
                </div>
                <div class="mapping-slider-container">
                    <div class="mapping-slider-header">
                        <div class="mapping-slider-label">Sensitivity</div>
                        <div class="mapping-slider-value" id="modalSensitivityValue">1.0</div>
                    </div>
                    <input type="range" min="0.1" max="3" step="0.1" value="1.0" class="mapping-slider" id="modalSensitivitySlider">
                </div>
                <div class="mapping-form-group">
                    <label class="mapping-form-label">Effect Range</label>
                    <div class="mapping-form-row">
                        <div class="mapping-form-col">
                            <label class="mapping-form-label">Min Value</label>
                            <input type="number" class="mapping-form-input" id="modalRangeMin" value="50">
                        </div>
                        <div class="mapping-form-col">
                            <label class="mapping-form-label">Max Value</label>
                            <input type="number" class="mapping-form-input" id="modalRangeMax" value="150">
                        </div>
                    </div>
                </div>
                <div class="mapping-checkbox-container">
                    <input type="checkbox" class="mapping-checkbox" id="modalInvertMapping">
                    <label class="mapping-checkbox-label">Invert Mapping (reverse direction)</label>
                </div>
                <div class="mapping-modal-footer">
                    <button class="mapping-modal-btn mapping-modal-cancel" id="modalCancelBtn">Cancel</button>
                    <button class="mapping-modal-btn mapping-modal-save" id="modalSaveBtn">Save Mapping</button>
                </div>
            </div>
        </div>
        
        <!-- Common Controls -->
        <div class="file-controls">
            <input type="file" id="fileInput" accept="video/*">
            <label for="fileInput" class="file-label">Choose Video File</label>
            <div class="file-name" id="fileName">No file selected</div>
        </div>
        
        <div class="sensor-section" id="sensorSectionControls">
            <div class="sensor-heading">
                <div class="sensor-title">Motion Controls</div>
                <button id="sensorToggleBtn" class="sensor-toggle">Enable Sensors</button>
            </div>
            <div class="mapping-info" id="sensorMappingInfo">
                <!-- Content will be set by JavaScript -->
            </div>
            <div class="sensor-values">
                <div class="sensor-value"><div class="value-label">Alpha (°)</div><div id="orientAlpha" class="value-number">0.00</div></div>
                <div class="sensor-value"><div class="value-label">Beta (°)</div><div id="orientBeta" class="value-number">0.00</div></div>
                <div class="sensor-value"><div class="value-label">Gamma (°)</div><div id="orientGamma" class="value-number">0.00</div></div>
            </div>
            <div style="display: flex; justify-content: center;"> <!-- Centering compass -->
                <div class="compass">
                    <div id="compassNeedle" class="compass-needle"></div>
                    <div class="compass-center"></div>
                    <div class="compass-marker">
                        <span class="north">N</span><span class="east">E</span><span class="south">S</span><span class="west">W</span>
                    </div>
                </div>
            </div>
            <div class="sensor-configuration">
                <div class="sensor-config-title">Sensor Sensitivity Settings</div>
                <div class="sensor-config-controls">
                    <div class="sensor-config-control">
                        <div class="config-label"><span>Alpha Sensitivity</span><span class="config-value" id="alphaSensValue">1.0</span></div>
                        <input type="range" min="0.1" max="2" step="0.1" value="1" class="config-slider" id="alphaSensitivitySlider">
                    </div>
                    <div class="sensor-config-control">
                        <div class="config-label"><span>Beta Sensitivity</span><span class="config-value" id="betaSensValue">1.0</span></div>
                        <input type="range" min="0.1" max="2" step="0.1" value="1" class="config-slider" id="betaSensitivitySlider">
                    </div>
                    <div class="sensor-config-control">
                        <div class="config-label"><span>Gamma Sensitivity</span><span class="config-value" id="gammaSensValue">1.0</span></div>
                        <input type="range" min="0.1" max="2" step="0.1" value="1" class="config-slider" id="gammaSensitivitySlider">
                    </div>
                    <div class="sensor-config-control">
                        <div class="config-label"><span>Smoothing</span><span class="config-value" id="smoothingValue">0.3</span></div>
                        <input type="range" min="0" max="0.9" step="0.1" value="0.3" class="config-slider" id="smoothingSlider">
                    </div>
                </div>
                <div class="sensor-config-title">Manual Offset Adjustments</div>
                <div class="sensor-config-controls">
                    <div class="sensor-config-control">
                        <div class="config-label"><span>Alpha Offset</span><span class="config-value" id="alphaOffsetValue">0°</span></div>
                        <input type="range" min="-180" max="180" step="5" value="0" class="config-slider" id="alphaOffsetSlider">
                    </div>
                    <div class="sensor-config-control">
                        <div class="config-label"><span>Beta Offset</span><span class="config-value" id="betaOffsetValue">0°</span></div>
                        <input type="range" min="-45" max="45" step="1" value="0" class="config-slider" id="betaOffsetSlider">
                    </div>
                    <div class="sensor-config-control">
                        <div class="config-label"><span>Gamma Offset</span><span class="config-value" id="gammaOffsetValue">0°</span></div>
                        <input type="range" min="-45" max="45" step="1" value="0" class="config-slider" id="gammaOffsetSlider">
                    </div>
                </div>
                <div class="sensor-actions">
                    <button id="calibrateBtn" class="sensor-action-btn">Calibrate</button>
                    <button id="invertBtn" class="sensor-action-btn">Invert Controls</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const videoPlayer = document.getElementById('videoPlayer');
            const mainVideoContainer = document.getElementById('mainVideoContainer');
            const videoPlaceholder = document.getElementById('videoPlaceholder');
            const videoPlayerControls = document.getElementById('videoPlayerControls');
            const videoFilterControls = document.getElementById('videoFilterControls');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const loopBtn = document.getElementById('loopBtn');
            const fileInput = document.getElementById('fileInput');
            const fileName = document.getElementById('fileName');
            const progressBar = document.getElementById('progressBar');
            const mainProgressContainer = document.getElementById('mainProgressContainer'); 
            const currentTimeEl = document.getElementById('currentTime');
            const durationEl = document.getElementById('duration');
            const volumeSlider = document.getElementById('volumeSlider');
            const loopInfo = document.getElementById('loopInfo');
            
            const brightnessSlider = document.getElementById('brightnessSlider');
            const saturationSlider = document.getElementById('saturationSlider');
            const contrastSlider = document.getElementById('contrastSlider');
            const hueRotateSlider = document.getElementById('hueRotateSlider');
            const blurSlider = document.getElementById('blurSlider');
            const brightnessValue = document.getElementById('brightnessValue');
            const saturationValue = document.getElementById('saturationValue');
            const contrastValue = document.getElementById('contrastValue');
            const hueRotateValue = document.getElementById('hueRotateValue');
            const blurValue = document.getElementById('blurValue');
            const resetFiltersBtn = document.getElementById('resetFiltersBtn');
            
            const videoFullscreenBtn = document.getElementById('videoFullscreenBtn');
            const fullscreenControlsOverlay = document.getElementById('fullscreenControlsOverlay');
            const progressBarFullscreen = document.getElementById('progressBarFullscreen');
            const playPauseFullscreen = document.getElementById('playPauseFullscreen');
            const exitVideoFullscreenBtn = document.getElementById('exitVideoFullscreenBtn');
            const fullscreenProgressContainer = fullscreenControlsOverlay.querySelector('.progress-container');

            // Point Cloud Elements
            const pointCloudCanvas = document.getElementById('pointCloudCanvas');
            const mainPointCloudContainer = document.getElementById('mainPointCloudContainer');
            const pointCloudParams = document.getElementById('pointCloudParams');
            const densitySlider = document.getElementById('densitySlider');
            const densityValue = document.getElementById('densityValue');
            const displacementSlider = document.getElementById('displacementSlider');
            const displacementValue = document.getElementById('displacementValue');
            const pointSizeSlider = document.getElementById('pointSizeSlider');
            const pointSizeValue = document.getElementById('pointSizeValue');
            const tiltSensitivitySlider = document.getElementById('tiltSensitivitySlider'); 
            const tiltSensitivityValue = document.getElementById('tiltSensitivityValue'); 

            // Sensor Elements
            const sensorToggleBtn = document.getElementById('sensorToggleBtn');
            const sensorMappingInfo = document.getElementById('sensorMappingInfo');
            const orientAlpha = document.getElementById('orientAlpha');
            const orientBeta = document.getElementById('orientBeta');
            const orientGamma = document.getElementById('orientGamma');
            const compassNeedle = document.getElementById('compassNeedle');
            const alphaSensitivitySlider = document.getElementById('alphaSensitivitySlider');
            const betaSensitivitySlider = document.getElementById('betaSensitivitySlider');
            const gammaSensitivitySlider = document.getElementById('gammaSensitivitySlider');
            const smoothingSlider = document.getElementById('smoothingSlider');
            const alphaSensValue = document.getElementById('alphaSensValue');
            const betaSensValue = document.getElementById('betaSensValue');
            const gammaSensValue = document.getElementById('gammaSensValue');
            const smoothingValue = document.getElementById('smoothingValue');
            const alphaOffsetSlider = document.getElementById('alphaOffsetSlider'); 
            const betaOffsetSlider = document.getElementById('betaOffsetSlider');   
            const gammaOffsetSlider = document.getElementById('gammaOffsetSlider'); 
            const alphaOffsetValue = document.getElementById('alphaOffsetValue'); 
            const betaOffsetValue = document.getElementById('betaOffsetValue');   
            const gammaOffsetValue = document.getElementById('gammaOffsetValue'); 
            const calibrateBtn = document.getElementById('calibrateBtn');
            const invertBtn = document.getElementById('invertBtn');

            // Mode Switching Elements
            const showVideoPlayerModeBtn = document.getElementById('showVideoPlayerModeBtn');
            const showPointCloudModeBtn = document.getElementById('showPointCloudModeBtn');
            const showMappingsModeBtn = document.getElementById('showMappingsModeBtn');
            const videoPlayerModeContent = document.getElementById('videoPlayerModeContent');
            const pointCloudModeContent = document.getElementById('pointCloudModeContent');
            const sensorMappingsModeContent = document.getElementById('sensorMappingsModeContent');

            // Mapping UI Elements
            const listViewBtn = document.getElementById('listViewBtn');
            const gridViewBtn = document.getElementById('gridViewBtn');
            const mappingListView = document.getElementById('mappingListView');
            const mappingGridView = document.getElementById('mappingGridView');
            const addMappingBtn = document.getElementById('addMappingBtn');
            const addMappingBtnGrid = document.getElementById('addMappingBtnGrid');
            const mappingModal = document.getElementById('mappingModal');
            const modalSensorSelect = document.getElementById('modalSensorSelect');
            const modalEffectSelect = document.getElementById('modalEffectSelect');
            const modalSensorDescription = document.getElementById('modalSensorDescription');
            const modalEffectDescription = document.getElementById('modalEffectDescription');
            const modalSensitivitySlider = document.getElementById('modalSensitivitySlider');
            const modalSensitivityValue = document.getElementById('modalSensitivityValue');
            const modalRangeMin = document.getElementById('modalRangeMin');
            const modalRangeMax = document.getElementById('modalRangeMax');
            const modalInvertMapping = document.getElementById('modalInvertMapping');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');
            const modalSaveBtn = document.getElementById('modalSaveBtn');

            // Testing Mode Elements
            const testingModeToggle = document.getElementById('testingModeToggle');
            const testingControls = document.getElementById('testingControls');
            const testAlphaSlider = document.getElementById('testAlphaSlider');
            const testBetaSlider = document.getElementById('testBetaSlider');
            const testGammaSlider = document.getElementById('testGammaSlider');
            const testMicSlider = document.getElementById('testMicSlider');
            const testLightSlider = document.getElementById('testLightSlider');
            const testAccelXSlider = document.getElementById('testAccelXSlider');
            const micLevelValue = document.getElementById('micLevelValue');
            const micLevelBar = document.getElementById('micLevelBar');
            const lightLevelValue = document.getElementById('lightLevelValue');

            // --- State Variables ---
            let currentMode = 'videoPlayer'; // 'videoPlayer', 'pointCloud', or 'sensorMappings'
            let isLooping = true; // Loop by default
            let loopCount = 0;
            let mappingViewMode = 'list'; // 'list' or 'grid'
            
            let sensorsGloballyEnabled = false; // Master switch for sensor processing
            let deviceOrientationPermissionGranted = false;
            let controlsInverted = false;
            let calibrationValues = { alpha: 0, beta: 0, gamma: 0 };
            let manualOffsets = { alpha: 0, beta: 0, gamma: 0 }; 
            let lastVideoFilterValues = { 
                brightness: 100, 
                saturation: 100, 
                contrast: 100,
                hueRotate: 0,
                blur: 0
            };

            let testingModeEnabled = false;
            let microphoneStream = null;
            let audioContext = null;
            let analyser = null;
            let audioDataArray = null;
            let lightSensorSupported = false;
            let currentLightLevel = null;
            
            let pointCloudCtx;
            let pointCloudAnimationFrameId;
            const tempCanvas = document.createElement('canvas'); 
            const tempCtx = tempCanvas.getContext('2d', { willReadFrequently: true }); 
            let pointCloudConfig = {
                density: 32,
                displacementScale: 50,
                pointSize: 3,
                tiltSensitivity: 10
            };
            let pointCloudTiltAngles = { beta: 0, gamma: 0 };

            // --- Sensor Mappings Data Structure ---
            // Available sensors and their configuration
            const availableSensors = [
                { id: 'alpha', name: 'Rotation (Alpha)', description: 'Device rotation around z-axis (compass direction)', unit: '°', min: 0, max: 360, default: 180 },
                { id: 'beta', name: 'Tilt Forward/Back (Beta)', description: 'Device tilt front/back', unit: '°', min: -90, max: 90, default: 0 },
                { id: 'gamma', name:
