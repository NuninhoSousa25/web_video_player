// js/device_detection.js - Save this as a separate file
const DeviceDetection = (function() {
    let deviceInfo = {
        type: 'unknown', // 'mobile', 'androidtv', 'desktop'
        platform: 'unknown', // 'android', 'ios', 'windows', 'linux', 'mac'
        hasTouch: false,
        hasSensors: false,
        hasKeyboard: false,
        hasMouse: false,
        isAndroidTV: false,
        capabilities: {
            orientation: false,
            motion: false,
            proximity: false,
            microphone: false,
            gamepad: false
        }
    };

    function detectDevice() {
        const userAgent = navigator.userAgent.toLowerCase();
        const standalone = window.navigator.standalone;
        const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        
        // Platform detection
        if (/android/.test(userAgent)) {
            deviceInfo.platform = 'android';
            
            // Android TV detection
            if (/tv|television|smarttv|googletv|androidtv/.test(userAgent) || 
                window.screen.width >= 1280 && window.screen.height >= 720 && !hasTouch) {
                deviceInfo.type = 'androidtv';
                deviceInfo.isAndroidTV = true;
                deviceInfo.hasKeyboard = true;
                deviceInfo.hasMouse = true;
            } else {
                deviceInfo.type = 'mobile';
            }
        } else if (/iphone|ipad|ipod/.test(userAgent)) {
            deviceInfo.platform = 'ios';
            deviceInfo.type = 'mobile';
        } else if (/windows/.test(userAgent)) {
            deviceInfo.platform = 'windows';
            deviceInfo.type = 'desktop';
            deviceInfo.hasKeyboard = true;
            deviceInfo.hasMouse = true;
        } else if (/mac/.test(userAgent)) {
            deviceInfo.platform = 'mac';
            deviceInfo.type = 'desktop';
            deviceInfo.hasKeyboard = true;
            deviceInfo.hasMouse = true;
        } else if (/linux/.test(userAgent)) {
            deviceInfo.platform = 'linux';
            deviceInfo.type = 'desktop';
            deviceInfo.hasKeyboard = true;
            deviceInfo.hasMouse = true;
        }

        deviceInfo.hasTouch = hasTouch;
        
        // Additional Android TV checks
        if (deviceInfo.platform === 'android' && !hasTouch) {
            if (window.screen.width >= 1280 || window.screen.height >= 720) {
                deviceInfo.type = 'androidtv';
                deviceInfo.isAndroidTV = true;
            }
        }

        console.log('Device detected:', deviceInfo);
        return deviceInfo;
    }

    async function detectCapabilities() {
        // Orientation capability
        if (typeof DeviceOrientationEvent !== 'undefined') {
            if (DeviceOrientationEvent.requestPermission) {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    deviceInfo.capabilities.orientation = permission === 'granted';
                } catch (e) {
                    deviceInfo.capabilities.orientation = false;
                }
            } else {
                deviceInfo.capabilities.orientation = deviceInfo.type !== 'androidtv';
            }
        }

        // Motion capability  
        if (typeof DeviceMotionEvent !== 'undefined') {
            if (DeviceMotionEvent.requestPermission) {
                try {
                    const permission = await DeviceMotionEvent.requestPermission();
                    deviceInfo.capabilities.motion = permission === 'granted';
                } catch (e) {
                    deviceInfo.capabilities.motion = false;
                }
            } else {
                deviceInfo.capabilities.motion = deviceInfo.type !== 'androidtv';
            }
        }

        // Proximity capability
        deviceInfo.capabilities.proximity = 'ProximitySensor' in window && deviceInfo.type === 'mobile';

        // Microphone capability
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            try {
                const testStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { echoCancellation: false } 
                });
                testStream.getTracks().forEach(track => track.stop());
                deviceInfo.capabilities.microphone = true;
            } catch (e) {
                deviceInfo.capabilities.microphone = false;
            }
        }

        // Gamepad capability
        deviceInfo.capabilities.gamepad = 'getGamepads' in navigator;

        console.log('Device capabilities:', deviceInfo.capabilities);
        return deviceInfo.capabilities;
    }

    function getDeviceInfo() {
        return deviceInfo;
    }

    function isAndroidTV() {
        return deviceInfo.isAndroidTV;
    }

    function isMobile() {
        return deviceInfo.type === 'mobile';
    }

    function isDesktop() {
        return deviceInfo.type === 'desktop';
    }

    function hasRealSensors() {
        return deviceInfo.capabilities.orientation || deviceInfo.capabilities.motion;
    }

    function adaptUIForDevice() {
        const body = document.body;
        
        body.classList.add(`device-${deviceInfo.type}`);
        body.classList.add(`platform-${deviceInfo.platform}`);
        
        if (deviceInfo.isAndroidTV) {
            body.classList.add('android-tv');
            
            const style = document.createElement('style');
            style.textContent = `
                .android-tv {
                    font-size: 18px;
                    cursor: pointer;
                }
                
                .android-tv button {
                    min-height: 48px;
                    font-size: 16px;
                    border: 2px solid transparent;
                    transition: all 0.2s ease;
                }
                
                .android-tv button:focus,
                .android-tv button:hover {
                    border-color: #2c7be5;
                    background-color: #1a68d1;
                    outline: none;
                    transform: scale(1.05);
                }
                
                .android-tv input[type="range"]:focus {
                    outline: 2px solid #2c7be5;
                    outline-offset: 2px;
                }
                
                .android-tv select:focus {
                    outline: 2px solid #2c7be5;
                    outline-offset: 2px;
                }
                
                .android-tv .main-controls {
                    gap: 12px;
                }
                
                .android-tv .toggle-button {
                    min-width: 120px;
                }
                
                .android-tv .filter-controls,
                .android-tv .point-cloud-params-container {
                    padding: 16px 20px;
                }
                
                .android-tv .sensor-values {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 15px;
                }
                
                .android-tv .touch-help {
                    display: none;
                }
            `;
            document.head.appendChild(style);
            
            addKeyboardNavigationHints();
        }
        
        if (!deviceInfo.hasTouch) {
            body.classList.add('no-touch');
            
            const style = document.createElement('style');
            style.textContent = `
                .no-touch video {
                    cursor: pointer;
                }
                
                .no-touch canvas {
                    cursor: pointer;
                }
                
                .no-touch button:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                }
            `;
            document.head.appendChild(style);
        }
    }

    function addKeyboardNavigationHints() {
        const infoDiv = document.createElement('div');
        infoDiv.id = 'keyboard-hints';
        infoDiv.style.cssText = `
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        `;
        infoDiv.innerHTML = `
            <div><strong>Keyboard Shortcuts:</strong></div>
            <div>Space: Play/Pause</div>
            <div>F: Fullscreen</div>
            <div>Tab: Navigate controls</div>
            <div>Enter: Activate button</div>
            <div>Esc: Exit fullscreen</div>
        `;
        document.body.appendChild(infoDiv);
        
        let hintsShown = false;
        document.addEventListener('keydown', function(e) {
            if (!hintsShown && (e.key === 'Tab' || e.key === 'Enter')) {
                infoDiv.style.display = 'block';
                hintsShown = true;
                setTimeout(() => {
                    infoDiv.style.display = 'none';
                }, 5000);
            }
        });
    }

    function setupKeyboardShortcuts() {
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            switch(e.key) {
                case ' ':
                    e.preventDefault();
                    const playBtn = document.getElementById('playPauseBtn');
                    if (playBtn) playBtn.click();
                    break;
                    
                case 'f':
                case 'F':
                    e.preventDefault();
                    const fullscreenBtn = document.getElementById('videoFullscreenBtn');
                    if (fullscreenBtn) fullscreenBtn.click();
                    break;
                    
                case 'l':
                case 'L':
                    e.preventDefault();
                    const loopBtn = document.getElementById('loopBtn');
                    if (loopBtn) loopBtn.click();
                    break;
                    
                case 'm':
                case 'M':
                    e.preventDefault();
                    const volumeSlider = document.getElementById('volumeSlider');
                    if (volumeSlider) {
                        volumeSlider.value = volumeSlider.value > 0 ? 0 : 1;
                        volumeSlider.dispatchEvent(new Event('input'));
                    }
                    break;
            }
        });
    }

    async function init() {
        detectDevice();
        await detectCapabilities();
        adaptUIForDevice();
        
        if (deviceInfo.type === 'androidtv' || !deviceInfo.hasTouch) {
            setupKeyboardShortcuts();
        }
        
        return deviceInfo;
    }

    return {
        init,
        getDeviceInfo,
        isAndroidTV,
        isMobile,
        isDesktop,
        hasRealSensors,
        adaptUIForDevice
    };
})();
